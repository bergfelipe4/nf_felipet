<% format_datetime = lambda do |value|
     next "‚Äî" if value.blank?
     time = Time.zone.parse(value) rescue nil
     time ? l(time, format: :short) : value
   end %>

<!-- HEADER -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
  <div>
    <h1 class="h3 mb-1">Notas emitidas no Sistema</h1>
    <p class="text-muted mb-0">
      As notas abaixo foram consultadas automaticamente usando o CPF cadastrado no seu perfil: 
      <strong><%= current_user.cpf %></strong>
    </p>
  </div>

  <%= link_to "Emitir nova nota", new_notas_fiscai_path, class: "btn btn-outline-primary" %>
</div>

<!-- ALERTA DE ERRO -->
<% if @consulta_error.present? %>
  <div class="alert alert-warning shadow-sm"><%= @consulta_error %></div>
<% end %>

<!-- CARDS DE STATUS DO RETORNO -->
<% if @consulta_result.present? %>
  <div class="row gy-3 mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted mb-1">C√≥digo HTTP</p>
          <h3 class="h4 mb-0"><%= @consulta_result["codigo"] || "‚Äî" %></h3>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted mb-1">Mensagem retornada</p>
          <h3 class="h5 mb-0"><%= @consulta_result["mensagem"] || "‚Äî" %></h3>
        </div>
      </div>
    </div>
  </div>
<% end %>

 <div class="card-body p-0">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>Chave</th>
          <th>S√©rie</th>
          <th>Emiss√£o</th>
          <th>Status</th>
          <th class="text-center">A√ß√µes</th>
        </tr>
      </thead>
<tbody>
  <% if @notas_consulta.present? %>
    <% @notas_consulta.each do |nota| %>

      <% numero = nota["CHAVE"] || "‚Äî" %>
      <% serie  = nota["SERIE"] || "‚Äî" %>
      <% data   = format_datetime.call(nota["DT_INI"]) %>

      <% cstat   = (nota["CSTAT_AUTORIZAR"] || nota["CSTAT_CONSULTA"]).to_i %>
      <% motivo  = nota["XMOTIVO_AUTORIZAR"] || nota["XMOTIVO_CONSULTA"] || "‚Äî" %>

      <%# üîµ L√≥gica de cor baseada no cStat %>
      <% badge_class, icon =
        if cstat.between?(100, 199)
          ["bg-success", "fa-check-circle"]          # OK
        elsif cstat.between?(200, 299)
          ["bg-warning text-dark", "fa-exclamation-circle"] # Corrigir
        elsif cstat.between?(300, 399)
          ["bg-danger", "fa-times-circle"]           # Erro grave
        else
          ["bg-secondary", "fa-question-circle"]     # Valor estranho
        end
      %>

      <tr>
        <td><%= numero %></td>
        <td><%= serie %></td>
        <td><%= data %></td>

        <td>
          <span class="badge <%= badge_class %>">
            <i class="fas <%= icon %> me-1"></i>
            <%= "#{cstat} ‚Äî #{motivo}" %>
          </span>
        </td>

        <td class="text-center">

          <%# üîç Visualizar %>
          <%= link_to "#", class: "btn btn-sm btn-outline-primary me-1" do %>
            <i class="fas fa-eye"></i>
          <% end %>

          <%# ‚¨áÔ∏è Baixar XML %>
          <% if nota["XML_ASSINADO_AUTORIZACAO"].present? %>
            <%= link_to "#", class: "btn btn-sm btn-outline-secondary me-1" do %>
              <i class="fas fa-file-download"></i>
            <% end %>
          <% else %>
            <button class="btn btn-sm btn-outline-secondary me-1" disabled>
              <i class="fas fa-file-download"></i>
            </button>
          <% end %>

          <%# üóëÔ∏è Excluir %>
          <%= link_to "#", class: "btn btn-sm btn-outline-danger" do %>
            <i class="fas fa-trash-alt"></i>
          <% end %>

        </td>
      </tr>

    <% end %>

  <% else %>
    <tr>
      <td colspan="5" class="text-center text-muted py-4">
        Nenhuma nota encontrada para exibir.
      </td>
    </tr>
  <% end %>
</tbody>


    </table>
  </div>