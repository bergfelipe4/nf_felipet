<% format_datetime = lambda do |value|
     next "—" if value.blank?
     time = Time.zone.parse(value) rescue nil
     time ? l(time, format: :short) : value
   end %>

<!-- HEADER -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <h1 class="h3 ">Notas emitidas no Sistema</h1>
  <%= link_to "Emitir nova nota", new_notas_fiscai_path, class: "btn btn-outline-primary" %>
</div>

<!-- ALERTA DE ERRO -->
<% if @consulta_error.present? %>
  <div class="alert alert-warning shadow-sm"><%= @consulta_error %></div>
<% end %>
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <form action="<%= notas_fiscais_path %>" method="get" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Chave</label>
        <input name="q[CHAVE_cont]" value="<%= params.dig(:q, :CHAVE_cont) %>" class="form-control" placeholder="parte da chave">
      </div>

      <div class="col-md-3">
        <label class="form-label">Série</label>
        <input name="q[SERIE_eq]" value="<%= params.dig(:q, :SERIE_eq) %>" class="form-control" placeholder="Série">
      </div>

      <div class="col-md-3">
        <label class="form-label">cStat</label>
        <input name="q[CSTAT_eq]" value="<%= params.dig(:q, :CSTAT_eq) %>" class="form-control" placeholder="ex: 100">
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100">Buscar</button>
      </div>
    </form>
  </div>
</div>




 <div class="card-body p-0">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>Chave</th>
          <th>Série</th>
          <th>Emissão</th>
          <th>Status</th>
          <th class="text-center">Ações</th>
        </tr>
      </thead>
<tbody>
  <% if @notas_paginadas.present? %>
    <% @notas_paginadas.each do |nota| %>

      <% numero = nota["CHAVE"] || "—" %>
      <% serie  = nota["SERIE"] || "—" %>
      <% data   = format_datetime.call(nota["DT_INI"]) %>

      <% cstat   = (nota["CSTAT_AUTORIZAR"] || nota["CSTAT_CONSULTA"]).to_i %>
      <% motivo  = nota["XMOTIVO_AUTORIZAR"] || nota["XMOTIVO_CONSULTA"] || "—" %>

      <% badge_class, icon =
        if cstat.between?(100, 199)
          ["bg-success", "fa-check-circle"]
        elsif cstat.between?(200, 299)
          ["bg-warning text-dark", "fa-exclamation-circle"]
        elsif cstat.between?(300, 399)
          ["bg-danger", "fa-times-circle"]
        else
          ["bg-secondary", "fa-question-circle"]
        end
      %>

      <tr>
        <td><%= numero %></td>
        <td><%= serie %></td>
        <td><%= data %></td>

        <td>
          <span class="badge <%= badge_class %>">
            <i class="fas <%= icon %> me-1"></i>
            <%= "#{cstat} — #{motivo}" %>
          </span>
        </td>

        <td class="text-center">
          <%= link_to notas_fiscai_path(nota["CHAVE"], cpf: @cpf_consulta),
                      class: "btn btn-sm btn-outline-primary me-1" do %>
            <i class="fas fa-eye"></i>
          <% end %>

          <% if nota["XML_ASSINADO_AUTORIZACAO"].present? %>
            <%= link_to "#", class: "btn btn-sm btn-outline-secondary me-1" do %>
              <i class="fas fa-file-download"></i>
            <% end %>
          <% else %>
            <button class="btn btn-sm btn-outline-secondary me-1" disabled>
              <i class="fas fa-file-download"></i>
            </button>
          <% end %>

          <%= link_to "#", class: "btn btn-sm btn-outline-danger" do %>
            <i class="fas fa-trash-alt"></i>
          <% end %>
        </td>
      </tr>

    <% end %>
  <% else %>
    <tr>
      <td colspan="5" class="text-center text-muted py-4">
        Nenhuma nota encontrada para exibir.
      </td>
    </tr>
  <% end %>
</tbody>




    </table>
<div class="d-flex justify-content-center my-3">
  <%== pagy_bootstrap_nav(@pagy) %>
</div>


  </div>